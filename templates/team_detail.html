<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ team.name }} - Team Space</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: '0 10px 30px rgba(15, 23, 42, 0.08)',
          },
        },
      },
    };
  </script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="mx-auto w-full max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
    <header class="mb-6 rounded-xl bg-white p-5 shadow-soft">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <a href="{% url 'dashboard-ui' %}" class="text-sm font-medium text-violet-600 hover:text-violet-700">
            &larr; Back to dashboard
          </a>
          <h1 class="mt-2 text-2xl font-bold tracking-tight">{{ team.name }}</h1>
          <p class="mt-1 text-sm text-slate-500">Team room, members, tasks, and chat.</p>
        </div>
        <button
          id="copyInvite"
          type="button"
          data-link="{{ request.scheme }}://{{ request.get_host }}{% url 'join-team' team.invite_code %}"
          class="inline-flex items-center justify-center rounded-xl bg-violet-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-violet-700"
        >
          Copy Invite Link
        </button>
      </div>
    </header>

    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for message in messages %}
          <div class="rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-soft">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <section class="mb-6 grid grid-cols-1 gap-4 md:grid-cols-3">
      <div class="rounded-xl bg-white p-5 shadow-soft">
        <p class="text-sm font-medium text-slate-600">Team Progress</p>
        {% widthratio team_completed team_total 100 as progress_ratio %}
        <p class="mt-1 text-2xl font-bold text-violet-600">
          {% if team_total %}{{ progress_ratio }}{% else %}0{% endif %}%
        </p>
        <div class="mt-3 h-2.5 w-full overflow-hidden rounded-full bg-slate-100">
          <div
            class="h-full rounded-full bg-violet-500 transition-all duration-700"
            style="width: {% if team_total %}{{ progress_ratio }}{% else %}0{% endif %}%"
          ></div>
        </div>
        <p class="mt-2 text-xs text-slate-500">{{ team_completed }} / {{ team_total }} completed</p>
      </div>

      <div class="rounded-xl bg-white p-5 shadow-soft">
        <p class="text-sm font-medium text-slate-600">Members</p>
        <p class="mt-1 text-2xl font-bold text-blue-600">{{ members|length }}</p>
        <p class="mt-2 text-xs text-slate-500">Including team lead</p>
      </div>

      <div class="rounded-xl bg-white p-5 shadow-soft">
        <p class="text-sm font-medium text-slate-600">Team Tasks</p>
        <p class="mt-1 text-2xl font-bold text-slate-900">{{ team_total }}</p>
        <p class="mt-2 text-xs text-slate-500">Shared tasks visible to all members</p>
      </div>
    </section>

    <section class="grid grid-cols-1 gap-6 lg:grid-cols-3">
      <div class="space-y-6 lg:col-span-1">
        <article class="rounded-xl bg-white p-5 shadow-soft">
          <h2 class="mb-4 text-lg font-semibold">Members</h2>
          <div class="space-y-3">
            {% for member in members %}
              <div class="flex items-center gap-3 rounded-xl border border-slate-200 p-3">
                {% if member.avatar_url %}
                  <img
                    src="{{ member.avatar_url }}"
                    alt="{{ member.username }} avatar"
                    class="h-10 w-10 rounded-full object-cover"
                  >
                {% else %}
                  <div class="flex h-10 w-10 items-center justify-center rounded-full bg-slate-200 text-sm font-semibold text-slate-600">
                    {{ member.username|slice:":1"|upper }}
                  </div>
                {% endif %}

                <div class="min-w-0 flex-1">
                  <p class="truncate text-sm font-semibold text-slate-800">{{ member.display_name }}</p>
                  <p class="truncate text-xs text-slate-500">@{{ member.username }}</p>
                </div>

                {% if member.is_lead %}
                  <span class="rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-700">Admin</span>
                {% endif %}
              </div>
            {% empty %}
              <p class="text-sm text-slate-500">No members yet.</p>
            {% endfor %}
          </div>
        </article>

        <article class="rounded-xl bg-white p-5 shadow-soft">
          <h2 class="mb-2 text-lg font-semibold">Invite</h2>
          <p class="mb-3 text-sm text-slate-500">Share this link to add new teammates.</p>
          <input
            readonly
            value="{{ request.scheme }}://{{ request.get_host }}{% url 'join-team' team.invite_code %}"
            class="w-full rounded-xl border border-slate-200 px-3 py-2 text-xs text-slate-600"
          >
        </article>
      </div>

      <div class="space-y-6 lg:col-span-2">
        <article class="rounded-xl bg-white p-5 shadow-soft">
          <h2 class="mb-4 text-lg font-semibold">Team Tasks</h2>
          <div class="space-y-3">
            {% for task in team_tasks %}
              <div class="flex items-start gap-3 rounded-xl border border-slate-200 p-3">
                <form method="post" action="{% url 'dashboard-toggle-task' task.id %}" class="pt-1">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.path }}">
                  <button
                    type="submit"
                    class="h-5 w-5 rounded-md border border-slate-300 text-xs {% if task.is_completed %}bg-violet-500 text-white{% else %}bg-white text-transparent{% endif %}"
                    title="Toggle complete"
                  >
                    &#10003;
                  </button>
                </form>
                <div class="min-w-0 flex-1">
                  <div class="mb-1 flex flex-wrap items-center gap-2">
                    <p class="truncate text-sm font-semibold {% if task.is_completed %}text-slate-400 line-through{% endif %}">
                      {{ task.title }}
                    </p>
                    <span class="rounded-full bg-violet-100 px-2 py-0.5 text-xs font-medium text-violet-700">Team</span>
                  </div>
                  {% if task.description %}
                    <p class="mb-1 text-sm text-slate-500">{{ task.description }}</p>
                  {% endif %}
                  <p class="text-xs text-slate-400">
                    Assignee: {{ task.responsible.username }}{% if task.due_date %} | Due: {{ task.due_date }}{% endif %}
                  </p>
                </div>
              </div>
            {% empty %}
              <div class="rounded-xl border border-dashed border-slate-300 p-6 text-center text-sm text-slate-500">
                No team tasks yet.
              </div>
            {% endfor %}
          </div>
        </article>

        <article class="rounded-xl bg-white p-5 shadow-soft">
          <div class="mb-4 flex items-center justify-between">
            <h2 class="text-lg font-semibold">Team Chat</h2>
            <p class="text-xs text-slate-500">Refresh page to see latest messages.</p>
          </div>

          <div id="chatMessages" class="mb-4 max-h-[380px] space-y-3 overflow-y-auto rounded-xl bg-slate-50 p-3">
            {% for message in chat_messages %}
              <div class="flex {% if message.author_id == request.user.id %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-[85%] rounded-2xl px-3 py-2 text-sm {% if message.author_id == request.user.id %}bg-violet-600 text-white{% else %}bg-white text-slate-700 border border-slate-200{% endif %}">
                  <p class="mb-1 text-xs {% if message.author_id == request.user.id %}text-violet-100{% else %}text-slate-400{% endif %}">
                    {{ message.author.username }} | {{ message.created_at|date:"M d, H:i" }}
                  </p>
                  <p class="whitespace-pre-wrap break-words">{{ message.content }}</p>
                </div>
              </div>
            {% empty %}
              <div class="rounded-xl border border-dashed border-slate-300 p-6 text-center text-sm text-slate-500">
                No messages yet. Start the conversation.
              </div>
            {% endfor %}
          </div>

          <form method="post" action="{% url 'team-send-message' team.id %}" class="space-y-3">
            {% csrf_token %}
            {{ message_form.content }}
            <div class="flex justify-end">
              <button
                type="submit"
                class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-slate-700"
              >
                Send
              </button>
            </div>
          </form>
        </article>
      </div>
    </section>
  </div>

  <script>
    const copyButton = document.getElementById('copyInvite');
    if (copyButton) {
      copyButton.addEventListener('click', async () => {
        const link = copyButton.dataset.link || '';
        if (!link) return;
        try {
          await navigator.clipboard.writeText(link);
          copyButton.textContent = 'Copied';
          setTimeout(() => {
            copyButton.textContent = 'Copy Invite Link';
          }, 1200);
        } catch (error) {
          window.prompt('Copy this link', link);
        }
      });
    }

    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  </script>
</body>
</html>
